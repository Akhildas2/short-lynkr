<div class="px-2 sm:px-4 max-w-screen-2xl" *ngIf="!error && !isLoading">

    <!-- Header Section -->
    <app-page-header [title]="'Analytics Dashboard'" [subtitle]="'Overview of key metrics and data'"
        [timeRanges]="timeRanges" [selectedRange]="selectedRange" [isLoading]="isLoading"
        (rangeChange)="changeRange($event)" (refresh)="refreshData()">
    </app-page-header>

    <!-- Summary Cards 1-->
    <div class="grid md:[grid-template-columns:repeat(auto-fill,minmax(17rem,1fr))] gap-6 mb-10">
        <!-- Total QR -->
        <app-summary-card title="Total QR" [value]="analyticsData?.totalQrs ?? 0" icon="qr_code" [change]="0"
            [changeText]="''" [iconBgClass]="getIconClasses('Total QR').bg"
            [iconColorClass]="getIconClasses('Total QR').color">
        </app-summary-card>

        <!-- Total Users -->
        <app-summary-card title="Total Users" [value]="analyticsData?.totalUsers ?? 0" icon="groups" [change]="0"
            [changeText]="''" [iconBgClass]="getIconClasses('Total Users').bg"
            [iconColorClass]="getIconClasses('Total Users').color">
        </app-summary-card>

        <!-- Blocked Users -->
        <app-summary-card title="Blocked Users" [value]="analyticsData?.blockedUsers ?? 0" icon="person_off"
            [change]="0" [changeText]="''" [iconBgClass]="getIconClasses('Blocked Users').bg"
            [iconColorClass]="getIconClasses('Blocked Users').color">
        </app-summary-card>

        <!-- Total URLs -->
        <app-summary-card title="Total URLs" [value]="analyticsData?.totalUrls ?? 0" icon="link" [change]="0"
            [changeText]="''" [iconBgClass]="getIconClasses('Total URLs').bg"
            [iconColorClass]="getIconClasses('Total URLs').color">
        </app-summary-card>

        <!-- Blocked URLs -->
        <app-summary-card title="Blocked URLs" [value]="analyticsData?.blockedUrls ?? 0" icon="block" [change]="0"
            [changeText]="''" [iconBgClass]="getIconClasses('Blocked URLs').bg"
            [iconColorClass]="getIconClasses('Blocked URLs').color">
        </app-summary-card>

        <!-- Top Device -->
        <app-summary-card [title]="'Top Device (' + timeRanges[selectedRange] + ')'" iconType="map"
            [value]="analyticsData?.topDevices?.[0]?.name || 'Unknown'" icon="devices_other" [change]="0"
            [changeText]="''" [iconMap]="deviceIconMap" fallbackIcon="fas fa-globe"
            [iconBgClass]="getIconClasses('Top Device ' + timeRanges[selectedRange]).bg"
            [iconColorClass]="getIconClasses('Top Device ' + timeRanges[selectedRange]).color">
        </app-summary-card>

        <!-- Top OS -->
        <app-summary-card [title]="'Top OS (' + timeRanges[selectedRange] + ')'" [iconType]="'map'"
            [value]="analyticsData?.topOS?.[0]?.name || 'Unknown'" icon="devices" [change]="0" [changeText]="''"
            [iconMap]="osIconMap" [iconBgClass]="getIconClasses('Top OS ' + timeRanges[selectedRange]).bg"
            [iconColorClass]="getIconClasses('Top OS ' + timeRanges[selectedRange]).color">
        </app-summary-card>

        <!-- Top Referrer -->
        <app-summary-card [title]="'Top Referrer (' + timeRanges[selectedRange] + ')'" [iconType]="'map'"
            [value]="analyticsData?.topReferrers?.[0]?.name || 'Unknown'" icon="share" [change]="0" [changeText]="''"
            [iconMap]="referrerIconMap" [iconBgClass]="getIconClasses('Top Referrer ' + timeRanges[selectedRange]).bg"
            [iconColorClass]="getIconClasses('Top Referrer ' + timeRanges[selectedRange]).color">
        </app-summary-card>

    </div>

    <!-- Summary Cards 2-->
    <div class="grid gap-6 mb-10 md:[grid-template-columns:repeat(auto-fit,minmax(17rem,1fr))]">

        <!-- Top Country -->
        <app-summary-card [title]="'Top Country (' + timeRanges[selectedRange] + ')'" [value]="topCountryName"
            icon="public" [change]="0" [flagClass]="topCountryFlag" [changeText]="''" [iconType]="'flag'"
            [iconBgClass]="getIconClasses('Top Country ' + timeRanges[selectedRange]).bg"
            [iconColorClass]="getIconClasses('Top Country ' + timeRanges[selectedRange]).color">
        </app-summary-card>

        <!-- Total Clicks -->
        <app-summary-card [title]="'Total Clicks (' + timeRanges[selectedRange] + ')'"
            [value]="analyticsData?.totalClicks ?? 0" icon="trending_up" [change]="analyticsData?.clicksChange ?? 0"
            [changeText]="getRangeComparisonText(selectedRange)"
            [iconBgClass]="getIconClasses('Total Clicks ' + timeRanges[selectedRange]).bg"
            [iconColorClass]="getIconClasses('Total Clicks ' + timeRanges[selectedRange]).color">
        </app-summary-card>

        <!-- Unique Visitors -->
        <app-summary-card [title]="'Unique Visitors (' + timeRanges[selectedRange] + ')'"
            [value]="analyticsData?.uniqueVisitors ?? 0" icon="people" [change]="analyticsData?.visitorsChange ?? 0"
            [changeText]="getRangeComparisonText(selectedRange)"
            [iconBgClass]="getIconClasses('Unique Visitors ' + timeRanges[selectedRange]).bg"
            [iconColorClass]="getIconClasses('Unique Visitors ' + timeRanges[selectedRange]).color">
        </app-summary-card>

    </div>

    <!-- Charts -->
    <div class="mb-10 gap-8 items-stretch grid md:[grid-template-columns:repeat(auto-fit,minmax(22rem,1fr))]">

        <!-- Clicks Over Time -->
        <div
            class="flex flex-col bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 hover:scale-105 border border-gray-200 dark:border-gray-700">

            <h2 class="text-xl font-semibold sm:text-lg">Clicks Over Time</h2>

            <div class="relative flex-grow h-96">
                <app-analytics-chart *ngIf="isLoading || hasTimelineClicks" chartType="line" [data]="timelineData"
                    [labels]="timelineLabels" [title]="'Clicks'" [loading]="isLoading">
                </app-analytics-chart>
                <div *ngIf="!hasTimelineClicks && !isLoading" @zoomIn>
                    <app-no-data variant="overlay" icon="bar_chart" title="No click timeline data available"
                        description="Interact with a link to see the chart."></app-no-data>
                </div>
            </div>

        </div>

        <!-- Multi Axis Line Chart -->
        <div
            class="flex flex-col bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 hover:scale-105 border border-gray-200 dark:border-gray-700">

            <h2 class="text-xl font-semibold mb-6 sm:text-lg">Users & URLs Over Time</h2>

            <div class="relative flex-grow h-96">
                <app-analytics-chart *ngIf="isLoading || hasCombinedTimelineData" chartType="line"
                    [labels]="combinedTimelineLabels" [data]="combinedTimelineData" [title]="'Users & URLs'"
                    [loading]="isLoading">
                </app-analytics-chart>

                <div *ngIf="!hasCombinedTimelineData && !isLoading" @zoomIn>
                    <app-no-data variant="overlay" icon="timeline" title="No user or URL timeline data available"
                        description=" Interact with a link to see the chart."></app-no-data>
                </div>
            </div>

        </div>

    </div>

    <!-- Top Locations -->
    <div
        class="flex flex-col bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 border border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-semibold mb-6">Clicks Over Time Locations</h2>

        <div class="relative flex-grow h-96">
            <app-map-chart *ngIf="isLoading || countryClickData.length > 0" [data]="countryClickData"
                [loading]="isLoading"></app-map-chart>

            <div *ngIf="countryClickData.length === 0 && !isLoading" @zoomIn
                class="absolute inset-0 flex items-center justify-center bg-gray-100 dark:bg-gray-800/80 rounded-xl p-4">
                <app-no-data variant="overlay" icon="public_off" title="No location data available"
                    description="Click a link to view geographic insights on the map."></app-no-data>
            </div>
        </div>

    </div>

    <!-- Stats Grid 1 -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8 items-stretch">
        <!-- Referrers -->
        <app-stats-list title="Referrers" [items]="referrerStats" [iconMap]="referrerIconMap"
            fallbackIcon="fas fa-globe" [showProgressBar]="true" noDataIcon="share" noDataVariant="overlay"
            noDataTitle="No referrer data available" noDataDescription="Click a shortened link to see referrers.">
        </app-stats-list>

        <!-- Browsers -->
        <app-stats-list title="Browsers & Platforms" [items]="browserStats" [iconMap]="browserIconMap"
            fallbackIcon="fas fa-question-circle" [showProgressBar]="false" noDataIcon="important_devices"
            noDataVariant="overlay" noDataTitle="No browser/platform data available"
            noDataDescription="Click a shortened link to see this.">
        </app-stats-list>
    </div>

    <!-- Stats Grid 2 -->
    <div class="mt-8 grid gap-8 items-stretch md:[grid-template-columns:repeat(auto-fit,minmax(22rem,1fr))]">
        <!-- Devices -->
        <app-stats-chart title="Devices" chartType="doughnut" [data]="deviceChartData" [labels]="deviceChartLabels"
            [iconMap]="deviceIconMap" [valueData]="deviceStats" [loading]="isLoading" [gridClass]="deviceGridClass"
            fallbackIcon="fas fa-laptop" noDataIcon="devices" noDataVariant="overlay"
            noDataTitle="No device data available" noDataDescription="Click a shortened link to see device stats.">
        </app-stats-chart>

        <!-- Operating Systems -->
        <app-stats-chart title="Operating Systems" chartType="pie" [data]="osChartData" [labels]="osChartLabels"
            [iconMap]="osIconMap" [valueData]="osStats" [loading]="isLoading" [gridClass]="osGridClass"
            fallbackIcon="fas fa-server" noDataIcon="devices_other" noDataVariant="overlay"
            noDataTitle="No OS data available" noDataDescription="Click a shortened link to see OS stats.">
        </app-stats-chart>
    </div>

    <!-- Stats Grid 3 -->
    <div class="mt-8 grid gap-8 md:[grid-template-columns:repeat(auto-fit,minmax(17rem,1fr))]">
        <!-- Top Countries -->
        <app-stats-list title="Top Countries" [items]="countryStats" [iconMap]="{ default: 'fas fa-flag' }"
            fallbackIcon="fas fa-flag" [showProgressBar]="true" noDataIcon="flag" noDataVariant="overlay"
            noDataTitle="No country data available" noDataDescription="Click a shortened link to see country data.">
        </app-stats-list>

        <!-- Top Regions -->
        <app-stats-list title="Top Regions" [items]="regionsStats" [iconMap]="{ default: 'fas fa-map-marker-alt' }"
            fallbackIcon="fas fa-map-marker-alt" [showProgressBar]="true" noDataIcon="map" noDataVariant="overlay"
            noDataTitle="No regions data available" noDataDescription="Click a shortened link to see region data.">
        </app-stats-list>

        <!-- Top Cities -->
        <app-stats-list title="Top Cities" [items]="citiesStats" [iconMap]="{ default: 'fas fa-mountain-city' }"
            fallbackIcon="fas fa-mountain-city" [showProgressBar]="false" noDataIcon="location_on"
            noDataVariant="overlay" noDataTitle="No cities data available"
            noDataDescription="Click a shortened link to see city data.">
        </app-stats-list>

    </div>

    <!-- Top URLs -->
    <div class="mt-8">

        <!-- Top URLs -->
        <app-top-card title="Top Performing URLs" [items]="topUrlsWithClicks" noDataIcon="link_off"
            noDataVariant="overlay" noDataTitle="No URL data available"
            noDataDescription="Top performing URLs will appear here.">
        </app-top-card>

    </div>

    <!-- Recent Activity -->
    <div class="mt-10">
        <h2 class="text-2xl font-bold mb-6">Recent Activity</h2>

        <ng-container *ngIf="recentActivity.length > 0; else noActivity">
            <app-activity-table [dataSource]="recentActivity" [displayedColumns]="displayedColumns"
                [deviceIconMap]="deviceIconMap" [referrerIconMap]="referrerIconMap" fallbackIcon="location_on"
                deviceIconMapFallbackIcon="fas fa-laptop" referrerIconMapFallbackIcon="fas fa-globe">
            </app-activity-table>

        </ng-container>

        <ng-template #noActivity>
            <app-no-data variant="card" icon="history" title="No recent activity found."
                description="Once you start creating and sharing links, your top URLs will show up here."></app-no-data>
        </ng-template>

    </div>

</div>

<div *ngIf="isLoading"
    class="absolute inset-0 flex items-center justify-center bg-white/70 dark:bg-gray-900/60 z-10 rounded-2xl">
    <app-spinner></app-spinner>
</div>

<!-- Scroll Buttons -->
<app-scroll-buttons *ngIf="!error" [isLoading]="isLoading"></app-scroll-buttons>

<!-- Error State -->
<app-error-message *ngIf="error && !isLoading" [title]="'Error loading Analytics'" [message]="error"
    [retryText]="'Reload Analytics'" [isLoading]="isLoading" [variant]="'error'" (retry)="refreshData()">
</app-error-message>