<div class="px-2 sm:px-4 max-w-screen-2xl">

    <!-- Header Section -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 px-4">
        <div>
            <h2 class="text-2xl sm:text-4xl font-extrabold tracking-tight text-gray-900 dark:text-gray-100">
                Analytics Dashboard
            </h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Overview of key metrics and data
            </p>
        </div>

        <button mat-raised-button (click)="!isLoading && refreshData()" [ngClass]="{
            'bg-primary hover:bg-blue-800 font-semibold py-2 px-4 transition-colors duration-200 ease-in-out': true,
            'opacity-50 cursor-not-allowed': isLoading }">
            <mat-icon class="text-white" [ngClass]="{'animate-spin': isLoading}">refresh</mat-icon>
            <span class="text-white" *ngIf="!isLoading">Refresh</span>
            <span class="text-white" *ngIf="isLoading">Loading...</span>
        </button>

    </div>

    <!-- Summary Cards -->
    <div class="grid md:[grid-template-columns:repeat(auto-fill,minmax(17rem,1fr))] gap-6 mb-10">
        <app-summary-card title="Total Users" [value]="analyticsData?.totalUsers ?? 0" icon="groups" [change]="0"
            [changeText]="''" [iconBgClass]="getIconClasses('Total Users').bg"
            [iconColorClass]="getIconClasses('Total Users').color">
        </app-summary-card>

        <!-- Blocked Users -->
        <app-summary-card title="Blocked Users" [value]="analyticsData?.blockedUsers ?? 0" icon="person_off"
            [change]="0" [changeText]="''" [iconBgClass]="getIconClasses('Blocked Users').bg"
            [iconColorClass]="getIconClasses('Blocked Users').color">
        </app-summary-card>

        <!-- Total URLs -->
        <app-summary-card title="Total URLs" [value]="analyticsData?.totalUrls ?? 0" icon="link" [change]="0"
            [changeText]="''" [iconBgClass]="getIconClasses('Total URLs').bg"
            [iconColorClass]="getIconClasses('Total URLs').color">
        </app-summary-card>

        <!-- Blocked URLs -->
        <app-summary-card title="Blocked URLs" [value]="analyticsData?.blockedUrls ?? 0" icon="block" [change]="0"
            [changeText]="''" [iconBgClass]="getIconClasses('Blocked URLs').bg"
            [iconColorClass]="getIconClasses('Blocked URLs').color">
        </app-summary-card>

        <!-- Top Country -->
        <app-summary-card [title]="'Top Country (' + timeRanges[selectedRange] + ')'" [value]="topCountryName"
            icon="public" [change]="0" [flagClass]="topCountryFlag" [changeText]="''" [iconType]="'flag'"
            [iconBgClass]="getIconClasses('Top Country ' + timeRanges[selectedRange]).bg"
            [iconColorClass]="getIconClasses('Top Country ' + timeRanges[selectedRange]).color">
        </app-summary-card>

        <!-- Top OS -->
        <app-summary-card [title]="'Top OS (' + timeRanges[selectedRange] + ')'" [iconType]="'os'"
            [value]="analyticsData?.topOS?.[0]?.name || 'Unknown'" icon="devices" [change]="0" [changeText]="''"
            [osIcon]="osIconMap" [iconBgClass]="getIconClasses('Top OS ' + timeRanges[selectedRange]).bg"
            [iconColorClass]="getIconClasses('Top OS ' + timeRanges[selectedRange]).color">
        </app-summary-card>

        <!-- Total Clicks -->
        <app-summary-card [title]="'Total Clicks (' + timeRanges[selectedRange] + ')'"
            [value]="analyticsData?.totalClicks ?? 0" icon="trending_up" [change]="analyticsData?.clicksChange ?? 0"
            [changeText]="getRangeComparisonText(selectedRange)"
            [iconBgClass]="getIconClasses('Total Clicks ' + timeRanges[selectedRange]).bg"
            [iconColorClass]="getIconClasses('Total Clicks ' + timeRanges[selectedRange]).color">
        </app-summary-card>

        <!-- Unique Visitors -->
        <app-summary-card [title]="'Unique Visitors (' + timeRanges[selectedRange] + ')'"
            [value]="analyticsData?.uniqueVisitors ?? 0" icon="people" [change]="analyticsData?.visitorsChange ?? 0"
            [changeText]="getRangeComparisonText(selectedRange)"
            [iconBgClass]="getIconClasses('Unique Visitors ' + timeRanges[selectedRange]).bg"
            [iconColorClass]="getIconClasses('Unique Visitors ' + timeRanges[selectedRange]).color">
        </app-summary-card>

    </div>

    <!-- Charts -->
    <div class="mb-10 gap-8 items-stretch grid md:[grid-template-columns:repeat(auto-fit,minmax(22rem,1fr))]">

        <!-- Clicks Over Time -->
        <div
            class="flex flex-col bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 hover:scale-105 border border-gray-200 dark:border-gray-700">

            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold sm:text-lg">Clicks Over Time</h2>
                <div>
                    <button mat-button [matMenuTriggerFor]="timeMenu">
                        {{ timeRanges[selectedRange] }}
                        <mat-icon>arrow_drop_down</mat-icon>
                    </button>
                    <mat-menu #timeMenu="matMenu">
                        <button mat-menu-item (click)="changeRange('1d')">Last 24 hours</button>
                        <button mat-menu-item (click)="changeRange('7d')">Last 7 days</button>
                        <button mat-menu-item (click)="changeRange('30d')">Last 30 days</button>
                        <button mat-menu-item (click)="changeRange('90d')">Last 90 days</button>
                    </mat-menu>
                </div>
            </div>

            <div class="relative flex-grow h-96">
                <app-analytics-chart *ngIf="isLoading || hasTimelineClicks" chartType="line" [data]="timelineData"
                    [labels]="timelineLabels" [title]="'Clicks'" [loading]="isLoading">
                </app-analytics-chart>
                <div *ngIf="!hasTimelineClicks && !isLoading" @zoomIn>
                    <app-no-data variant="overlay" icon="bar_chart" title="No click timeline data available"
                        description="Interact with a link to see the chart."></app-no-data>
                </div>
            </div>

        </div>

        <!-- Multi Axis Line Chart -->
        <div
            class="flex flex-col bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 hover:scale-105 border border-gray-200 dark:border-gray-700">

            <h2 class="text-xl font-semibold mb-6 sm:text-lg">Users & URLs Over Time</h2>

            <div class="relative flex-grow h-96">
                <app-analytics-chart *ngIf="isLoading || hasCombinedTimelineData" chartType="line"
                    [labels]="combinedTimelineLabels" [data]="combinedTimelineData" [title]="'Users & URLs'"
                    [loading]="isLoading">
                </app-analytics-chart>

                <div *ngIf="!hasCombinedTimelineData && !isLoading" @zoomIn>
                    <app-no-data variant="overlay" icon="timeline" title="No user or URL timeline data available"
                        description=" Interact with a link to see the chart."></app-no-data>
                </div>
            </div>

        </div>

    </div>

    <!-- Top Locations -->
    <div
        class="flex flex-col bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 hover:scale-105 border border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-semibold mb-6">Clicks Over Time Locations</h2>

        <div class="relative flex-grow h-96">
            <app-map-chart *ngIf="isLoading || countryClickData.length > 0" [data]="countryClickData"
                [loading]="isLoading"></app-map-chart>

            <div *ngIf="countryClickData.length === 0 && !isLoading" @zoomIn
                class="absolute inset-0 flex items-center justify-center bg-gray-100 dark:bg-gray-800/80 rounded-xl p-4">
                <app-no-data variant="overlay" icon="public_off" title="No location data available"
                    description="Click a link to view geographic insights on the map."></app-no-data>
            </div>
        </div>

    </div>

    <!-- Stats Grid 1 -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8 items-stretch">
        <!-- Referrers -->
        <app-stats-list title="Referrers" [items]="referrerStats" [iconMap]="referrerIconMap"
            fallbackIcon="fas fa-globe" [showProgressBar]="true" noDataIcon="share" noDataVariant="overlay"
            noDataTitle="No referrer data available" noDataDescription="Click a shortened link to see referrers.">
        </app-stats-list>

        <!-- Browsers -->
        <app-stats-list title="Browsers & Platforms" [items]="browserStats" [iconMap]="browserIconMap"
            fallbackIcon="fas fa-question-circle" [showProgressBar]="false" noDataIcon="important_devices"
            noDataVariant="overlay" noDataTitle="No browser/platform data available"
            noDataDescription="Click a shortened link to see this.">
        </app-stats-list>
    </div>

    <!-- Stats Grid 2 -->
    <div class="mt-8 grid gap-8 items-stretch md:[grid-template-columns:repeat(auto-fit,minmax(22rem,1fr))]">
        <!-- Devices -->
        <app-stats-chart title="Devices" chartType="doughnut" [data]="deviceChartData" [labels]="deviceChartLabels"
            [iconMap]="deviceIconMap" [valueData]="deviceStats" [loading]="isLoading" [gridClass]="deviceGridClass"
            fallbackIcon="fas fa-laptop" noDataIcon="devices" noDataVariant="overlay"
            noDataTitle="No device data available" noDataDescription="Click a shortened link to see device stats.">
        </app-stats-chart>

        <!-- Operating Systems -->
        <app-stats-chart title="Operating Systems" chartType="pie" [data]="osChartData" [labels]="osChartLabels"
            [iconMap]="osIconMap" [valueData]="osStats" [loading]="isLoading" [gridClass]="osGridClass"
            fallbackIcon="fas fa-server" noDataIcon="devices_other" noDataVariant="overlay"
            noDataTitle="No OS data available" noDataDescription="Click a shortened link to see OS stats.">
        </app-stats-chart>
    </div>

    <!-- Stats Grid 3 -->
    <div class="mt-8 grid gap-8 md:[grid-template-columns:repeat(auto-fit,minmax(17rem,1fr))]">
        <!-- Top Countries -->
        <app-stats-list title="Top Countries" [items]="countryStats" [iconMap]="{ default: 'fas fa-flag' }"
            fallbackIcon="fas fa-flag" [showProgressBar]="true" noDataIcon="flag" noDataVariant="overlay"
            noDataTitle="No country data available" noDataDescription="Click a shortened link to see country data.">
        </app-stats-list>

        <!-- Top Regions -->
        <app-stats-list title="Top Regions" [items]="regionsStats" [iconMap]="{ default: 'fas fa-map-marker-alt' }"
            fallbackIcon="fas fa-map-marker-alt" [showProgressBar]="true" noDataIcon="map" noDataVariant="overlay"
            noDataTitle="No regions data available" noDataDescription="Click a shortened link to see region data.">
        </app-stats-list>

        <!-- Top Cities -->
        <app-stats-list title="Top Cities" [items]="citiesStats" [iconMap]="{ default: 'fas fa-mountain-city' }"
            fallbackIcon="fas fa-mountain-city" [showProgressBar]="false" noDataIcon="location_on"
            noDataVariant="overlay" noDataTitle="No cities data available"
            noDataDescription="Click a shortened link to see city data.">
        </app-stats-list>

    </div>

    <!-- Top URLs -->
    <div class="mt-8">
        <h2 class="text-2xl font-semibold mb-4">Top URLs</h2>

        <div *ngIf="topUrlsWithClicks.length > 0"
            class="hidden sm:block overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700">
            <table class="min-w-full text-sm text-left text-gray-500 dark:text-gray-400">
                <thead class="text-base text-gray-700 bg-gray-100 dark:bg-gray-700 dark:text-gray-400">
                    <tr>
                        <th class="px-4 py-2">Short URL</th>
                        <th class="px-4 py-2">Original URL</th>
                        <th class="px-4 py-2">Clicks</th>
                    </tr>
                </thead>
                <tbody class="text-sm">
                    <tr *ngFor="let url of topUrlsWithClicks"
                        class="border-b dark:border-gray-700 odd:bg-white even:bg-gray-50 dark:odd:bg-gray-800 dark:even:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-150">
                        <td class="px-4 py-4 text-md truncate font-bold text-blue-500">
                            <a href="{{ url.shortUrl }}" target="_blank" class="hover:underline">
                                {{ url.shortUrl }}
                            </a>
                        </td>
                        <td class="px-4 py-4 truncate max-w-xs text-md font-medium">
                            <a href="{{ url.originalUrl }}" target="_blank" class="hover:underline text-blue-500">
                                {{ url.originalUrl }}
                            </a>
                        </td>
                        <td class="px-4 py-4 text-md font-medium">
                            {{ url.clicks }}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div *ngIf="topUrlsWithClicks.length > 0" class="sm:hidden space-y-4">
            <div *ngFor="let url of topUrlsWithClicks" class="p-4 rounded-2xl shadow-md border border-gray-200 dark:border-gray-700 
              bg-white dark:bg-gray-800 hover:shadow-lg transition-all duration-200">

                <!-- URL Header: Short URL -->
                <div class="flex justify-between items-center mb-2">
                    <span class="font-semibold text-gray-600 dark:text-gray-400">Short URL:</span>
                    <a href="{{ url.shortUrl }}" target="_blank"
                        class="text-blue-500 hover:underline truncate max-w-[60%] block">
                        {{ url.shortUrl }}
                    </a>
                </div>

                <!-- Original URL -->
                <div class="flex justify-between items-center mb-2">
                    <span class="font-semibold text-gray-600 dark:text-gray-400">Original URL:</span>
                    <a href="{{ url.originalUrl }}" target="_blank"
                        class="text-blue-500 hover:underline truncate max-w-[60%] block">
                        {{ url.originalUrl }}
                    </a>
                </div>

                <!-- Clicks -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <mat-icon class="text-gray-500 dark:text-gray-400 text-base">mouse</mat-icon>
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Clicks:</span>
                    </div>
                    <span class="text-sm font-bold text-gray-900 dark:text-gray-100">{{ url.clicks }}</span>
                </div>
            </div>
        </div>


        <ng-container *ngIf="topUrlsWithClicks.length === 0">
            <app-no-data variant="card" icon="link_off" title="No URL data available"
                description="Once people start interacting with your link, activity will show up here."></app-no-data>
        </ng-container>

    </div>

    <!-- Recent Activity -->
    <div class="mt-10">
        <h2 class="text-2xl font-bold mb-6">Recent Activity</h2>

        <ng-container *ngIf="recentActivity.length > 0; else noActivity">
            <app-activity-table [dataSource]="recentActivity" [displayedColumns]="displayedColumns"
                [deviceIconMap]="deviceIconMap" [referrerIconMap]="referrerIconMap" fallbackIcon="location_on"
                deviceIconMapFallbackIcon="fas fa-laptop" referrerIconMapFallbackIcon="fas fa-globe">
            </app-activity-table>

        </ng-container>

        <ng-template #noActivity>
            <app-no-data variant="card" icon="history" title="No recent activity found."
                description="Once you start creating and sharing links, your top URLs will show up here."></app-no-data>
        </ng-template>

    </div>

    <div *ngIf="isLoading"
        class="absolute inset-0 flex items-center justify-center bg-white/70 dark:bg-gray-900/60 z-10 rounded-2xl">
        <app-spinner></app-spinner>
    </div>

    <!-- Scroll Buttons -->
    <app-scroll-buttons [isLoading]="isLoading"></app-scroll-buttons>

</div>