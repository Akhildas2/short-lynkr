<div class="flex h-full bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans">

    <div class="flex flex-row w-full" *ngIf="messages.length > 0">
        <aside [ngClass]="{'hidden md:flex': selectedMessage, 'flex': !selectedMessage}"
            class="flex-col w-full sm:w-[30%] bg-white dark:bg-gray-900 h-full">

            <div class="px-4 py-4 space-y-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-xl md:text-2xl lg:text-3xl font-black tracking-tighter">Inbox</h1>
                    <div
                        class="px-3 py-1 rounded-full bg-blue-500 text-white text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-500/30">
                        {{ messages.length }} Total
                    </div>
                </div>
            </div>

            <!-- Messages + Pagination -->
            <div class="flex flex-col h-full">

                <!-- Messages (scrollable) -->
                <div class="flex-1 overflow-y-auto px-3 py-3 space-y-3 flex flex-col">

                    <div class="flex justify-end mb-2">
                        <button [matMenuTriggerFor]="filterMenu" class="flex items-center gap-1.5 px-3 py-2 border border-gray-300 dark:border-gray-600
                        rounded-lg bg-white dark:bg-gray-800 font-semibold transition
                        hover:bg-gray-100 dark:hover:bg-gray-700">

                            <span class="text-xs text-gray-500 dark:text-gray-300 font-bold uppercase tracking-wider"
                                [ngClass]="getFilterClass()">
                                {{ selectedStatusFilter | titlecase }}
                            </span>

                            <mat-icon class="ml-1 text-gray-500 dark:text-gray-300">
                                arrow_drop_down
                            </mat-icon>
                        </button>

                        <mat-menu #filterMenu="matMenu">
                            <button mat-menu-item (click)="setStatusFilter('all')">
                                All
                            </button>
                            <button mat-menu-item (click)="setStatusFilter('active')">
                                Active
                            </button>
                            <button mat-menu-item (click)="setStatusFilter('pending')">
                                Pending
                            </button>
                            <button mat-menu-item (click)="setStatusFilter('closed')">
                                Closed
                            </button>
                        </mat-menu>
                    </div>


                    <ng-container *ngIf="hasFilteredMessages; else emptyMessages">
                        <div *ngFor="let msg of paginatedMessages; trackBy: trackById" (click)="selectMessage(msg)"
                            class="relative p-4 rounded-xl shadow-md cursor-pointer transition bg-gray-50 dark:bg-gray-800"
                            [ngClass]="selectedMessage?._id === msg._id
           ? 'bg-blue-300 dark:bg-blue-500/10 border border-blue-400 dark:border-blue-600'
           : 'hover:bg-gray-100 dark:hover:bg-gray-800'">

                            <!-- Active bar -->
                            <span *ngIf="selectedMessage?._id === msg._id"
                                class="absolute left-0 top-3 bottom-3 w-[3px] bg-blue-500 rounded-r-full"></span>

                            <div class="flex justify-between items-center mb-1">
                                <div class="flex items-center gap-2">
                                    <span *ngIf="!msg.isRead" class="w-2 h-2 rounded-full bg-blue-500"></span>
                                    <span class="text-sm font-semibold truncate">
                                        {{ msg.name }}
                                    </span>
                                </div>

                                <span class="px-3 py-1 text-[10px] font-bold uppercase tracking-wider rounded-full"
                                    [ngClass]="getStatusClass(msg.status)">
                                    {{ msg.status }}
                                </span>
                            </div>

                            <p class="text-xs text-gray-600 dark:text-gray-400 line-clamp-1">
                                {{ msg.subject }}
                            </p>

                            <div class="flex justify-end">
                                <span class="text-[10px] font-medium">
                                    {{ msg.createdAt | date:'mediumDate' }}
                                </span>
                            </div>
                        </div>
                    </ng-container>

                    <ng-template #emptyMessages>

                        <!--  NO DATA AT ALL -->
                        <div *ngIf="messages.length === 0"
                            class="flex-1 flex flex-col items-center justify-center text-center">

                            <i class="fa-solid fa-inbox text-4xl text-gray-400 mb-4"></i>
                            <p class="text-sm font-semibold text-gray-500">No messages yet</p>
                            <p class="text-xs text-gray-400">New inquiries will appear here</p>
                        </div>

                        <!--  SEARCH ONLY – NO DATA -->
                        <div *ngIf="messages.length > 0 && isSearchActive && !isFilterActive"
                            class="flex-1 flex flex-col items-center justify-center text-center">

                            <i class="fa-solid fa-magnifying-glass text-4xl text-gray-400 mb-4"></i>
                            <p class="text-sm font-semibold text-gray-500">No search results</p>
                            <p class="text-xs text-gray-400">Try another keyword</p>
                        </div>

                        <!--  FILTER ONLY – NO DATA -->
                        <div *ngIf="messages.length > 0 && !isSearchActive && isFilterActive"
                            class="flex-1 flex flex-col items-center justify-center text-center">

                            <i class="fa-solid fa-filter text-4xl text-gray-400 mb-4"></i>
                            <p class="text-sm font-semibold text-gray-500">
                                No {{ selectedStatusFilter | titlecase }} messages
                            </p>
                            <p class="text-xs text-gray-400">Try another status</p>
                        </div>

                        <!--  SEARCH + FILTER – NO DATA -->
                        <div *ngIf="messages.length > 0 && isSearchActive && isFilterActive"
                            class="flex-1 flex flex-col items-center justify-center text-center">

                            <i class="fa-solid fa-circle-exclamation text-4xl text-gray-400 mb-4"></i>
                            <p class="text-sm font-semibold text-gray-500">
                                No matching messages
                            </p>
                            <p class="text-xs text-gray-400">
                                Try changing search or filter
                            </p>
                        </div>

                    </ng-template>


                </div>

                <!-- Pagination -->
                <div *ngIf="totalPages > 1" class="shrink-0 py-2 px-2 border-t border-gray-200 dark:border-gray-800
              bg-white dark:bg-gray-900">

                    <div class="flex items-center justify-between">

                        <span class="text-xs text-gray-500 flex justify-center">
                            Page {{ currentPage }} of {{ totalPages }}
                        </span>

                        <div class="flex gap-1">

                            <button mat-icon-button (click)="goToFirst()" [disabled]="currentPage === 1"
                                class="disabled:opacity-40 disabled:cursor-not-allowed">
                                <mat-icon class="flex justify-center">first_page</mat-icon>
                            </button>

                            <button mat-icon-button (click)="prevPage()" [disabled]="currentPage === 1"
                                class="disabled:opacity-40 disabled:cursor-not-allowed">
                                <mat-icon class="flex justify-center">chevron_left</mat-icon>
                            </button>

                            <button mat-icon-button (click)="nextPage()" [disabled]="currentPage === totalPages"
                                class="disabled:opacity-40 disabled:cursor-not-allowed">
                                <mat-icon class="flex justify-center">chevron_right</mat-icon>
                            </button>

                            <button mat-icon-button (click)="goToLast()" [disabled]="currentPage === totalPages"
                                class="disabled:opacity-40 disabled:cursor-not-allowed">
                                <mat-icon class="flex justify-center">last_page</mat-icon>
                            </button>

                        </div>
                    </div>
                </div>

            </div>

        </aside>

        <main [ngClass]="{'flex': selectedMessage, 'hidden md:flex': !selectedMessage}"
            class="flex-1 flex flex-col relative bg-white dark:bg-gray-900 h-full overflow-y-auto">

            <ng-container *ngIf="selectedMessage; else empty">
                <div class="px-4 py-6">

                    <div class="sticky z-20 w-full max-w-4xl mx-auto mb-8">
                        <div
                            class="h-16 px-4 bg-white dark:bg-gray-800/80 backdrop-blur-xl border border-gray-200 dark:border-gray-700 shadow-lg rounded-full flex items-center justify-between">

                            <div class="flex items-center gap-1 md:gap-2">
                                <button mat-icon-button (click)="selectedMessage = null" class="flex justify-center">
                                    <mat-icon>arrow_back</mat-icon>
                                </button>

                                <button mat-icon-button (click)="toggleReadStatus(selectedMessage)"
                                    [matTooltip]="selectedMessage.isRead ? 'Mark as unread' : 'Mark as read'"
                                    class="hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <mat-icon class="flex justify-center"
                                        [ngClass]="selectedMessage.isRead ? 'text-green-600' : 'text-gray-400'">
                                        {{ selectedMessage.isRead ? 'drafts' : 'mail' }}
                                    </mat-icon>
                                </button>

                                <button mat-icon-button (click)="deleteMessage(selectedMessage)"
                                    class="flex justify-center hover:bg-red-50 dark:hover:bg-red-900/30">
                                    <mat-icon class="text-red-500">delete_outline</mat-icon>
                                </button>
                            </div>

                            <div class="flex items-center gap-3">
                                <span
                                    class="hidden sm:inline-block px-3 py-1 text-[10px] font-bold uppercase tracking-wider rounded-full"
                                    [ngClass]="getStatusClass(selectedMessage.status)">
                                    {{ selectedMessage.status }}
                                </span>

                                <button mat-flat-button (click)="replyByMail()"
                                    class="bg-blue-600 hover:bg-blue-700 text-white !rounded-full px-3 sm:px-6 transition-all hover:scale-105 active:scale-95 shadow-md shadow-blue-500/20">
                                    <mat-icon class="mr-2 text-white">reply</mat-icon>
                                    <span class="truncate text-xs sm:text-sm">Reply</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="max-w-4xl mx-auto space-y-6">

                        <header
                            class="relative p-8 rounded-[2.5rem] bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-lg flex flex-col items-center text-center">

                            <div
                                class="absolute top-6 left-6 right-6 flex justify-between items-center text-[10px] font-bold uppercase tracking-widest text-gray-500 dark:text-gray-400">
                                <div
                                    class="flex items-center gap-1.5 bg-gray-100 dark:bg-gray-900 px-3 py-1 rounded-full border border-gray-200 dark:border-gray-700 truncate">
                                    <span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span>
                                    IP: {{ selectedMessage.ipAddress }}
                                </div>
                                <div
                                    class="ml-3 bg-gray-50 dark:bg-gray-900 px-3 py-1 rounded-full border border-gray-100 dark:border-gray-700 truncate">
                                    Received: {{ selectedMessage.createdAt | date:'shortTime' }}
                                </div>
                            </div>

                            <div class="mt-8 relative mb-4">
                                <div
                                    class="w-24 h-24 rounded-3xl p-1 bg-gradient-to-tr from-blue-500 to-violet-500 rotate-3 hover:rotate-0 transition-transform duration-300">
                                    <div
                                        class="w-full h-full rounded-[1.4rem] bg-white dark:bg-gray-900 flex items-center justify-center -rotate-3 hover:rotate-0 transition-transform duration-300">
                                        <span
                                            class="text-4xl font-black bg-clip-text text-transparent bg-gradient-to-tr from-blue-500 to-violet-500">
                                            {{ selectedMessage.name[0] }}
                                        </span>
                                    </div>
                                </div>
                                <div
                                    class="absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 border-4 border-white dark:border-gray-800 rounded-full">
                                </div>
                            </div>

                            <h2 class="text-3xl font-black tracking-tight text-gray-900 dark:text-white">{{
                                selectedMessage.name }}</h2>
                            <p class="text-gray-500 dark:text-gray-400 font-medium mb-8">{{ selectedMessage.email }} •
                                {{ selectedMessage.phoneNumber }}</p>

                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 w-full">
                                <div
                                    class="p-4 rounded-2xl bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-700">
                                    <p class="text-[10px] font-black uppercase text-gray-400 mb-1">Inquiry ID</p>
                                    <p class="text-sm font-mono font-bold text-gray-700 dark:text-gray-200">#{{
                                        selectedMessage.inquiryId }}</p>
                                </div>
                                <div
                                    class="p-4 rounded-2xl bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-700">
                                    <p class="text-[10px] font-black uppercase text-gray-400 mb-1">Platform</p>
                                    <p class="text-sm font-bold text-gray-700 dark:text-gray-200">{{
                                        selectedMessage.platform }}</p>
                                </div>
                                <div
                                    class="p-4 rounded-2xl bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-700">
                                    <p class="text-[10px] font-black uppercase text-gray-400 mb-1">Device</p>
                                    <p class="text-sm font-bold text-gray-700 dark:text-gray-200">{{
                                        selectedMessage.device }}</p>
                                </div>
                            </div>
                        </header>

                        <div
                            class="p-6 md:p-10 rounded-[2.5rem] bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 shadow-lg">

                            <div
                                class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-10 pb-6 border-b border-gray-100 dark:border-gray-700">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-full bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center">
                                        <mat-icon
                                            class="text-blue-600 dark:text-blue-400">chat_bubble_outline</mat-icon>
                                    </div>
                                    <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Message
                                        Content</span>
                                </div>

                                <div class="flex items-center gap-2" *ngIf="selectedMessage.status !== 'closed'">

                                    <!-- Filter Button -->
                                    <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">
                                        Status:
                                    </span>

                                    <button [matMenuTriggerFor]="statusMenu"
                                        class="flex items-center gap-1.5 shrink-0 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 font-semibold transition hover:bg-gray-100 dark:hover:bg-gray-700"
                                        [ngClass]="getStatus(selectedMessage.status)">
                                        <span class="max-w-[90px] truncate">
                                            {{ selectedMessage.status | titlecase }}
                                        </span>

                                        <mat-icon class="ml-1 text-gray-500 dark:text-gray-300">
                                            arrow_drop_down
                                        </mat-icon>
                                    </button>

                                    <!-- Dropdown Menu -->
                                    <mat-menu #statusMenu="matMenu">
                                        <button mat-menu-item (click)="setStatus('active')">Active</button>
                                        <button mat-menu-item (click)="setStatus('pending')">Pending</button>
                                        <button mat-menu-item (click)="setStatus('closed')">Closed</button>
                                    </mat-menu>

                                </div>
                            </div>

                            <div class="flex items-center gap-3 mb-8">
                                <div
                                    class="w-10 h-10 rounded-xl bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center">
                                    <mat-icon class="text-blue-600 dark:text-blue-400">subject</mat-icon>
                                </div>
                                <div>
                                    <p
                                        class="text-[10px] font-bold text-gray-400 uppercase tracking-widest leading-none mb-1">
                                        Subject Line</p>
                                    <h3 class="text-xl md:text-2xl font-bold text-gray-900 dark:text-white">{{
                                        selectedMessage.subject }}</h3>
                                </div>
                            </div>

                            <div
                                class="relative p-6 md:p-8 rounded-3xl bg-gray-100 dark:bg-gray-900/50 border border-gray-200 dark:border-gray-700 group">
                                <span
                                    class="absolute -top-3 left-6 px-3 py-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg text-[10px] font-black uppercase tracking-widest text-gray-400">
                                    Message Body
                                </span>
                                <p class="text-lg leading-relaxed text-gray-600 dark:text-gray-300 italic font-serif">
                                    "{{ selectedMessage.message }}"
                                </p>
                            </div>
                        </div>

                    </div>
                </div>
            </ng-container>

            <ng-template #empty>
                <div
                    class="flex-1 flex flex-col items-center justify-center p-12 text-center border rounded-3xl border-gray-200 dark:border-gray-800">
                    <div
                        class="w-32 h-32 rounded-full bg-white dark:bg-gray-800 shadow-2xl flex items-center justify-center mb-8 rotate-12">
                        <i class="fa-solid fa-envelope text-blue-500 text-5xl"></i>
                    </div>
                    <h3 class="text-2xl font-black tracking-tight mb-2">No Inquiry Selected</h3>
                    <p class="text-gray-500 max-w-xs mx-auto text-sm">Select a message from the sidebar to view details
                        and start a conversation.</p>
                </div>
            </ng-template>
        </main>

    </div>
    <div class="flex flex-col w-full" *ngIf="messages.length === 0">
        <!-- EMPTY STATE -->
        <app-empty-state *ngIf="!isLoading && messages.length === 0" icon="fa-solid fa-inbox" title="No Messages"
            description="There are no inquiries yet. New messages will appear here.">
        </app-empty-state>
    </div>

</div>