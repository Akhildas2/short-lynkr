<div class="min-h-screen bg-[var(--background-color)] text-[var(--text-color)] flex flex-col">
    <app-header></app-header>

    <main class="flex-grow px-8 md:px-12">
        <div class="container mx-auto max-w-7xl" *ngIf="urlList() as url">
            <div class="mb-10">
                <h1 class="text-3xl md:text-4xl font-bold mb-2">Analytics Dashboard</h1>
                <p>Track the performance of your <span class="font-bold hover:text-blue-600">{{ url.shortUrl}}</span>
                </p>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6 mb-10">
                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 transition-transform hover:scale-[1.02]">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 dark:text-gray-400">Total Clicks</p>
                            <p class="text-3xl font-bold">{{url.clicks}}</p>
                        </div>
                        <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-xl">
                            <mat-icon class="text-blue-500 dark:text-blue-400">trending_up</mat-icon>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="flex items-center"
                            [ngClass]="(url?.clicksChange || 0) >= 0 ? 'text-green-500' : 'text-red-500'">
                            <mat-icon [ngClass]="(url?.clicksChange || 0) >= 0 ? 'text-green-500' : 'text-red-500'">
                                {{(url?.clicksChange || 0) >= 0 ? 'arrow_upward' : 'arrow_downward' }}
                            </mat-icon>
                            <span class="ml-1">{{ url?.clicksChange || 0 }}% {{ getRangeComparisonText(selectedRange)
                                }}</span>
                        </div>
                    </div>
                </div>

                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 transition-transform hover:scale-[1.02]">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 dark:text-gray-400">Unique Visitors</p>
                            <p class="text-3xl font-bold">{{ url.uniqueVisitors }}</p>
                        </div>
                        <div class="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-xl">
                            <mat-icon class="text-purple-500 dark:text-purple-400">people</mat-icon>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="flex items-center"
                            [ngClass]="(url?.visitorsChange || 0) >= 0 ? 'text-green-500' : 'text-red-500'">
                            <mat-icon [ngClass]="(url?.visitorsChange || 0) >= 0 ? 'text-green-500' : 'text-red-500'">
                                {{ (url?.visitorsChange || 0) >= 0 ? 'arrow_upward' : 'arrow_downward'}}
                            </mat-icon>
                            <span class="ml-1">{{ url?.visitorsChange || 0 }}% {{ getRangeComparisonText(selectedRange)
                                }}</span>
                        </div>
                    </div>
                </div>

                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 transition-transform hover:scale-[1.02]">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 dark:text-gray-400">Top Country</p>
                            <p class="text-3xl font-bold">{{ url.topCountry || 'Unknown' }}</p>
                        </div>
                        <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-xl">
                            <mat-icon class="text-green-500 dark:text-green-400">public</mat-icon>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            {{ url.topCountryPercentage || 0 }}% of total traffic
                        </p>
                        <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                            Based on {{ selectedRange === '1d' ? 'today' : 'selected period' }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
                <!-- Clicks Over Time -->
                <div class="flex flex-col bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">Clicks Over Time</h2>
                        <div>
                            <button mat-button [matMenuTriggerFor]="timeMenu">
                                {{ timeRanges[selectedRange] }}
                                <mat-icon>arrow_drop_down</mat-icon>
                            </button>
                            <mat-menu #timeMenu="matMenu">
                                <button mat-menu-item (click)="changeRange('1d')">Last 24 hours</button>
                                <button mat-menu-item (click)="changeRange('7d')">Last 7 days</button>
                                <button mat-menu-item (click)="changeRange('30d')">Last 30 days</button>
                                <button mat-menu-item (click)="changeRange('90d')">Last 90 days</button>
                            </mat-menu>
                        </div>
                    </div>
                    <div class="relative flex-grow h-96">
                        <app-analytics-chart *ngIf="hasTimelineClicks" chartType="line" [data]="timelineData"
                            [labels]="timelineLabels" [title]="'Clicks Over Time'" [loading]="isLoading">
                        </app-analytics-chart>

                        <div *ngIf="!hasTimelineClicks && !isLoading" @zoomIn
                            class="absolute inset-0 flex items-center justify-center bg-gray-100 dark:bg-gray-700/50 rounded-xl">
                            <p class="text-gray-600"> No click data available. Interact with a link to see the chart.
                            </p>
                        </div>
                    </div>

                </div>

                <!-- Top Locations -->
                <div class="flex flex-col bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6">
                    <h2 class="text-xl font-semibold mb-6">Clicks Over Time Locations</h2>
                    <div class="relative flex-grow h-96">
                        <app-map-chart *ngIf="countryClickData.length > 0" [data]="countryClickData"
                            [loading]="isLoading"></app-map-chart>

                        <div *ngIf="countryClickData.length === 0 && !isLoading" @zoomIn
                            class="absolute inset-0 flex items-center justify-center bg-gray-100 dark:bg-gray-700/50 rounded-xl">
                            <p class="text-gray-600"> No location data available. Click a link to view the map.</p>
                        </div>
                    </div>
                    <div *ngIf="countryClickData.length > 0 && !isLoading" class="mt-6">
                        <h2 class="text-lg font-semibold mb-4 text-center"> Top {{ countryClickData.length > 3 ? 3 :
                            countryClickData.length }} Top Locations</h2>

                        <div [ngClass]="deviceGridClass + ' gap-4 mt-4 text-center'" @fadeInLeft>
                            <div *ngFor="let item of countryClickData |slice:0:3" class="text-center">
                                <div class="text-2xl font-bold">{{ item.countryCode }}</div>
                                <div class="text-sm text-gray-500"> ({{ item.value }})</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

                <!-- Referrers -->
                <app-stats-list title="Referrers" [items]="referrerStats" [iconMap]="referrerIconMap"
                    fallbackIcon="travel_explore" [showProgressBar]="true"
                    emptyText="No referrer data available. Click a shortened link to see referrers.">
                </app-stats-list>

                <!-- Browsers -->
                <app-stats-list title="Browsers & Platforms" [items]="browserStats" [iconMap]="browserIconMap"
                    fallbackIcon="public" [showProgressBar]="false"
                    emptyText="No browser/platform data available. Click a shortened link to see this.">
                </app-stats-list>

                <!-- Devices -->
                <app-stats-chart title="Devices" chartType="doughnut" [data]="deviceChartData"
                    [labels]="deviceChartLabels" [valueData]="deviceStats" [loading]="isLoading"
                    [gridClass]="deviceGridClass"
                    emptyText="No device data available. Click a shortened link to see device stats.">
                </app-stats-chart>

                <!-- OS -->
                <app-stats-chart title="Operating Systems" chartType="pie" [data]="osChartData" [labels]="osChartLabels"
                    [valueData]="osStats" [loading]="isLoading" [gridClass]="deviceGridClass"
                    emptyText="No OS data available. Click a shortened link to see OS stats.">
                </app-stats-chart>

            </div>

            <!-- Recent Activity -->
            <div class="mt-10">
                <h2 class="text-2xl font-bold mb-6">Recent Activity</h2>
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl overflow-hidden">
                    <table mat-table [dataSource]="recentActivity" class="w-full">
                        <!-- Timestamp Column -->
                        <ng-container matColumnDef="timestamp">
                            <th mat-header-cell *matHeaderCellDef>Time</th>
                            <td mat-cell *matCellDef="let element">
                                <div class="font-medium">{{element.timestamp | date:'short'}}</div>
                            </td>
                        </ng-container>

                        <!-- Location Column -->
                        <ng-container matColumnDef="location">
                            <th mat-header-cell *matHeaderCellDef>Location</th>
                            <td mat-cell *matCellDef="let element">
                                <div class="flex items-center">
                                    <mat-icon class="mr-2 text-gray-500">location_on</mat-icon>
                                    {{element.location}}
                                </div>
                            </td>
                        </ng-container>

                        <!-- Device Column -->
                        <ng-container matColumnDef="device">
                            <th mat-header-cell *matHeaderCellDef>Device</th>
                            <td mat-cell *matCellDef="let element">
                                <div class="flex items-center">
                                    <mat-icon class="mr-2 text-gray-500">{{element.deviceIcon}}</mat-icon>
                                    {{element.device}}
                                </div>
                            </td>
                        </ng-container>

                        <!-- Referrer Column -->
                        <ng-container matColumnDef="referrer">
                            <th mat-header-cell *matHeaderCellDef>Referrer</th>
                            <td mat-cell *matCellDef="let element">
                                <div class="flex items-center">
                                    <mat-icon class="mr-2 text-gray-500">link</mat-icon>
                                    {{element.referrer || 'Direct'}}
                                </div>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <app-footer class="mt-auto"></app-footer>
</div>