<div class="px-4 sm:px-8 md:px-12">

  <div class="max-w-7xl mx-auto mb-4 px-4">

    <!-- Header -->
    <app-user-page-header [title]="'URL Manager'" [isLoading]="isLoading" [showSearch]="urlList().length > 0"
      [searchTerm]="searchTerm()" (searchTermChange)="searchTerm.set($event)" [showFilter]="urlList().length > 0"
      [filterStatusLabel]="filterStatusLabel()" [filterOptions]="filterOptions" (filterChange)="changeFilter($event)"
      [createButtonText]="'Create New'" [createButtonLink]="'/qr-generator'">
    </app-user-page-header>

    <!-- Create New Button -->
    <div *ngIf="isLoading" class="flex flex-col items-center justify-center flex-1 min-h-[calc(100vh-7rem-7rem)]">
      <app-spinner></app-spinner>
      <p class="text-gray-400 animate-pulse">Loading your urls...</p>
    </div>

    <!-- Empty state when no URLs exist -->
    <app-empty-state *ngIf="!isLoading && urlList().length === 0" icon="fas fa-warning" title="No URLs Found"
      description="You donâ€™t have any shortened URLs yet. Create your first one now and start sharing!"
      actionText="Create Your First URL" actionIcon="fas fa-link" actionRoute="/home">
    </app-empty-state>

    <!-- Empty State when search yields no results -->
    <app-empty-state
      *ngIf="!isLoading && filteredUrls().length === 0 && urlList().length > 0 && searchTerm() && !filterStatus()"
      icon="fas fa-search" title="No URLs Found for Your Search"
      description="No URLs match your search term. Try refining or clearing your search." clearText="Clear Search"
      clearIcon="fas fa-times" [clearCallback]="clearSearch.bind(this)">
    </app-empty-state>

    <!-- Empty State when filter yields no results -->
    <app-empty-state
      *ngIf="!isLoading && filteredUrls().length === 0 && urlList().length > 0 && !searchTerm() && filterStatus()"
      icon="fas fa-filter" title="No URLs Match This Filter"
      description="No URLs match your selected status filter. Try changing or clearing the filter."
      clearText="Clear Filter" clearIcon="fas fa-filter-circle-xmark" [clearCallback]="clearFilter.bind(this)">
    </app-empty-state>

    <!-- Empty State when both search and filter yield no results -->
    <app-empty-state
      *ngIf="!isLoading && filteredUrls().length === 0 && urlList().length > 0 && searchTerm() && filterStatus()"
      icon="fas fa-search-minus" title="No URLs Match Search and Filter"
      description="No URLs match your search term and selected status filter. Try refining or clearing them."
      clearText="Clear Search & Filter" clearIcon="fas fa-times-circle"
      [clearCallback]="clearSearchAndFilter.bind(this)">
    </app-empty-state>

    <!-- QR Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" *ngIf="!isLoading">
      <div *ngFor="let url of paginatedUrls(); trackBy: trackByUrlId" class="group h-full">

        <div
          class="relative h-full flex flex-col bg-white dark:bg-gray-800 backdrop-blur-lg border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 hover:-translate-y-2 overflow-hidden">

          <div
            class="absolute inset-0 rounded-2xl bg-gradient-to-r from-[var(--primary-color)] to-[var(--accent-color)] opacity-0 group-hover:opacity-20 transition-opacity duration-300">
          </div>

          <!-- Header with Action Menu -->
          <div class="flex flex-wrap justify-between items-start p-2 gap-2">

            <!-- Left side: status badge + tags -->
            <div class="flex flex-row flex-wrap gap-2 max-w-full">
              <!-- status badge -->
              <div
                class="flex items-center gap-2 px-2 py-0.5 rounded-full text-xs font-bold uppercase tracking-wider bg-opacity-10 backdrop-blur-md border border-opacity-20"
                [ngClass]="url.isBlocked ? 'bg-rose-500 text-rose-700 dark:text-rose-300 border-rose-500': 'bg-emerald-500 text-emerald-700 dark:text-emerald-300 border-emerald-500'">
                <span class="w-2 h-2 rounded-full"
                  [ngClass]="url.isBlocked ? 'bg-rose-500 animate-pulse' : 'bg-emerald-500 animate-pulse'"></span>
                {{url.isBlocked ? 'Blocked' : 'Active'}}
              </div>


              <!-- Tag Preview -->
              <div class="relative" (appClickOutside)="closeTagsDropdown(url._id)">
                <div *ngIf="url.tags.length > 0" class="flex items-center gap-1">

                  <!-- First Tag -->
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] sm:text-xs font-semibold 
                bg-indigo-100 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-300">
                    <mat-icon class="mr-1 icon-xs">tag</mat-icon>
                    {{ url.tags[0] }}
                  </span>

                  <!-- +N more -->
                  <button *ngIf="url.tags.length > 1" (click)="toggleTagsDropdown(url._id)"
                    class="text-xs font-bold text-indigo-600 dark:text-indigo-400 hover:underline">
                    +{{ url.tags.length - 1 }} more
                  </button>
                </div>

                <!-- Tags Dropdown -->
                <div *ngIf="tagsDropdown[url._id]" class="absolute left-0 sm:left-auto sm:right-0 top-full mt-1 w-32 sm:w-56 
            bg-white dark:bg-gray-900 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-2 z-40">

                  <div class="flex flex-wrap gap-2">
                    <span *ngFor="let tag of url.tags" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium
                   bg-gradient-to-r from-purple-100 to-pink-100 text-purple-800
                   dark:from-purple-900/30 dark:to-pink-900/30 dark:text-purple-300">
                      <mat-icon class="mr-1 icon-xs">tag</mat-icon>
                      {{ tag }}
                    </span>
                  </div>

                </div>
              </div>
            </div>

            <!-- Right side: more menu button -->
            <div class="relative ml-auto" (appClickOutside)="closeDropdown()">
              <button (click)="toggleDropdown(url._id, $event)"
                class="flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-400 hover:text-indigo-500 transition-colors">
                <mat-icon class="font-extrabold">more_horiz</mat-icon>
              </button>

              <!-- Dropdown Menu -->
              <div *ngIf="isDropdownActive(url._id)"
                class="absolute right-0 top-full w-48 bg-white dark:bg-gray-900 rounded-xl shadow-2xl border border-gray-100 dark:border-gray-700 z-50 overflow-hidden transform origin-top-right transition-all">
                <div class="flex flex-col p-1">

                  <!-- View URL -->
                  <button (click)="viewUrl(url)" class="w-full flex items-center px-3 py-2 text-sm 
                   text-gray-800 dark:text-gray-200 
                   hover:bg-indigo-100 dark:hover:bg-indigo-700/30 rounded-lg transition-colors">
                    <mat-icon class="mr-2 text-indigo-600 dark:text-indigo-400 icon-xs">visibility</mat-icon>
                    View
                  </button>

                  <!-- Block/Unblock -->
                  <button (click)="toggleBlock(url)" class="w-full flex items-center px-3 py-2 text-sm 
                   text-gray-800 dark:text-gray-200 rounded-lg transition-colors"
                    [ngClass]="url.isBlocked ? 'hover:bg-green-100 dark:hover:bg-green-700/30': 'hover:bg-red-100 dark:hover:bg-red-700/30'">
                    <mat-icon class="mr-2 icon-xs"
                      [ngClass]="url.isBlocked ? 'text-green-600 dark:text-green-400'  : 'text-red-600 dark:text-red-400'">
                      {{ url.isBlocked ? 'check_circle' : 'block' }}
                    </mat-icon>
                    {{ url.isBlocked ? 'Unblock' : 'Block' }}
                  </button>

                  <!-- Edit Details -->
                  <button *ngIf="adminSettings?.urlSettings?.urlCustomization" (click)="editUrl(url)" class="w-full flex items-center px-3 py-2 text-sm 
                   text-gray-700 dark:text-gray-300 
                   hover:bg-blue-100 dark:hover:bg-blue-700/30 rounded-lg transition-colors">
                    <mat-icon class="mr-2 text-blue-600 dark:text-blue-400 icon-xs">edit</mat-icon>
                    Edit Details
                  </button>

                  <!-- Delete URL -->
                  <button (click)="deleteUrl(url)" class="w-full flex items-center px-3 py-2 text-sm 
                   text-gray-700 dark:text-gray-300 
                   hover:bg-red-100 dark:hover:bg-red-700/30 rounded-lg transition-colors">
                    <mat-icon class="mr-2 text-red-600 dark:text-red-400 icon-xs">delete</mat-icon>
                    Delete URL
                  </button>

                </div>
              </div>
            </div>
          </div>

          <!-- Card Content -->
          <div class="flex-1 flex flex-col justify-start items-center p-2 space-y-4">

            <!-- QR Code -->
            <div class="relative">
              <img [src]="url.qrCode?.qrCodeUrl" alt="QR code"
                class="relative w-32 h-32 rounded-2xl shadow-lg hover:scale-110 transition-transform duration-300 bg-white mx-auto">
            </div>

            <!-- URLs Section -->
            <div class="w-full text-center space-y-3">
              <!-- Short URL -->
              <div
                class="inline-flex items-center gap-4 max-w-full bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-500/20 px-4 py-2 rounded-xl">
                <span
                  class="flex-1 z-10 text-center cursor-pointer text-sm sm:text-base break-all text-indigo-600 dark:text-indigo-400 font-bold truncate hover:underline"
                  (click)="openUrlHandler(url.shortUrl, false)">
                  {{ url.shortUrl }}
                </span>

                <button (click)="copyUrl(url.shortUrl)"
                  class="z-10 flex justify-center items-center rounded-md text-xs  px-2 py-1 bg-gray-300 dark:bg-gray-700 flex-shrink-0"
                  matTooltip="Copy to clipboard">
                  <!-- DEFAULT STATE -->
                  <span *ngIf="!copied[url.shortUrl]"
                    class="flex items-center font-extrabold text-gray-700 dark:text-gray-200">
                    <mat-icon class="text-xs font-extrabold flex justify-center items-center">content_copy</mat-icon>
                    Copy
                  </span>

                  <!-- SUCCESS STATE  -->
                  <span *ngIf="copied[url.shortUrl]"
                    class="flex items-center font-extrabold text-green-600 dark:text-green-400">
                    <mat-icon
                      class="text-xs font-extrabold flex justify-center items-center text-green-600 dark:text-green-400">check_circle</mat-icon>
                    Copied
                  </span>

                </button>
              </div>

              <!-- Original URL -->
              <div
                class="cursor-pointer relative z-20 bg-gray-100 dark:bg-gray-900 rounded-xl p-4 border-l-4 border-[var(--primary-color)]"
                (click)="openUrlHandler(url.originalUrl, true)">

                <span class="block text-sm text-gray-700 dark:text-gray-300 truncate">
                  {{ url.originalUrl }}
                </span>
              </div>
            </div>

          </div>

          <!-- Footer Section -->
          <div class="p-4 border-t border-gray-400 dark:border-gray-600 bg-gray-50 dark:bg-gray-800/50 rounded-b-3xl">

            <div class="grid grid-cols-2 gap-4 mb-4">

              <!-- Total Clicks -->
              <div class="text-center bg-gray-100 dark:bg-gray-700 p-2 rounded-lg shadow-inner">
                <p class="text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400">Total Clicks</p>
                <div class="flex items-center justify-center space-x-1 text-green-600 dark:text-green-400">
                  <mat-icon class="icon-sm">trending_up</mat-icon>
                  <span class="text-xl font-extrabold">{{url.clicks}}</span>
                </div>
              </div>

              <!-- Created -->
              <div class="text-center bg-gray-100 dark:bg-gray-700 p-2 rounded-lg shadow-inner">
                <p class="text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400">Created</p>
                <div class="flex items-center justify-center space-x-1 text-blue-600 dark:text-blue-400">
                  <mat-icon class="icon-sm">calendar_today</mat-icon>
                  <span class="text-sm font-bold">{{url.createdAt | date:'shortDate'}}</span>
                </div>
              </div>

              <!-- Expires At -->
              <div *ngIf="url.expiresAt && !url.clickLimit"
                class="text-center bg-gray-100 dark:bg-gray-700 p-2 rounded-lg shadow-inner col-span-2">
                <p class="text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400">Expires</p>
                <div class="flex items-center justify-center space-x-1 text-red-600 dark:text-red-400">
                  <mat-icon class="icon-sm">schedule</mat-icon>
                  <span class="text-sm font-bold">{{url.expiresAt | date:'shortDate'}}</span>
                </div>
              </div>

              <!-- Click Limit -->
              <div *ngIf="url.clickLimit && !url.expiresAt"
                class="text-center bg-gray-100 dark:bg-gray-700 p-2 rounded-lg shadow-inner col-span-2">
                <p class="text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400">Click Limit</p>
                <div class="flex items-center justify-center space-x-1 text-yellow-600 dark:text-yellow-400">
                  <mat-icon class="icon-sm">mouse</mat-icon>
                  <span class="text-xl font-extrabold">{{url.clickLimit}}</span>
                </div>
              </div>

              <!-- Both Expires & Click Limit -->
              <ng-container *ngIf="url.expiresAt && url.clickLimit">
                <div class="text-center bg-gray-100 dark:bg-gray-700 p-2 rounded-lg shadow-inner">
                  <p class="text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400">Expires</p>
                  <div class="flex items-center justify-center space-x-1 text-red-600 dark:text-red-400">
                    <mat-icon class="icon-sm">schedule</mat-icon>
                    <span class="text-sm font-bold">{{url.expiresAt | date:'shortDate'}}</span>
                  </div>
                </div>

                <div class="text-center bg-gray-100 dark:bg-gray-700 p-2 rounded-lg shadow-inner">
                  <p class="text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400">Click Limit</p>
                  <div class="flex items-center justify-center space-x-1 text-yellow-600 dark:text-yellow-400">
                    <mat-icon class="icon-sm">mouse</mat-icon>
                    <span class="text-xl font-extrabold">{{url.clickLimit}}</span>
                  </div>
                </div>
              </ng-container>

            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-1 gap-3">
              <!-- Analytics Button -->
              <button mat-stroked-button [routerLink]="['/user/analytics',url._id]"
                class="w-full transition-all duration-300 hover:translate-y-[-2px] shadow-md hover:shadow-lg rounded-md border-[var(--primary-color)] text-[var(--accent-color)]">
                <span
                  class="text-base font-bold bg-gradient-to-r from-[var(--primary-color)] to-[var(--accent-color)] bg-clip-text text-transparent">
                  Analytics
                </span>
                <mat-icon class="ml-2 text-[var(--primary-color)]">bar_chart</mat-icon>
              </button>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <mat-paginator *ngIf="filteredUrls().length > 6 && !isLoading" class="w-full mt-5" [length]="filteredUrls().length"
      [pageSize]="pageSize()" [showFirstLastButtons]="showFirstLastButtons" [pageIndex]="pageIndex()"
      [pageSizeOptions]="[ 6, 15, 30, 50, 100]" (page)="onPageChange($event)">
    </mat-paginator>
  </div>

  <!-- Scroll Buttons -->
  <app-scroll-buttons *ngIf="filteredUrls().length > 15 && !isLoading" [isLoading]="isLoading"></app-scroll-buttons>

</div>